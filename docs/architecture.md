## Architecture

Ably contains a collection of *experiments*.

Each *experiment* has its own *randomizer* and its own *scope*.

![Ably experiment architecture](ably-experiment-architecture.png)

### Randomizer ###

A randomizer assigns test subjects to groups.

A randomizer matches the following prototype:

```js
/**
 * Assigns to a variant by calling the callback
 * @param  {Function} callback The callback to pass the variant to
 * @param  {Array}    variants An array of variants to choose from
 */
function randomizer(callback, variants);
```

#### Example

```js
/**
 * Assigns to a variant using the Math.random() method
 * @param  {Function} callback The callback to pass the variant to
 * @param  {Array}    variants An array of variants to choose from
 */
function exampleRandomizer(callback, variants) {
    callback(variants[Math.floor(Math.random() * variants.length)]);
}

// Example invocation
exampleRandomizer(function(assignment) {
    console.log('I was assigned to variant: ' + assignment);
}, ['red', 'green']);
```

#### Use an existing randomizer

Ably exposes a randomizer you can just start using.

##### ably.mathRandomRandomizer

A type of randomizer that assigns users to groups using the `Math.random()` function.

```js
ably.mathRandomRandomizer(function(assignment) {
    console.log('I was assigned to variant: ' + assignment);
}, ['red', 'green']);
```

#### Supply your own randomizer

##### Examples

Fetch the assignment from a dataset generated by the server.

```js
ably.setRandomizer(function myServerGeneratedRandomizer(callback, variants) {
    callback(document.getElementById('server-generated-data').dataset.assignment);
});
```

Fetch the assignment through AJAX.

```js
ably.setRandomizer(function myServerGeneratedRandomizer(callback, variants) {
    $.getJSON("/assigment", function(json) {
        callback(json.assigment);
    });
});
```

### Scope ###

A `Scope` represents the scope of an experiment. It marks the boundary of where the experiment begins and where it ends. An experiment can be run within the scope of a cookie or within the scope of a logged-in session. Scope is simply a key-value store which remembers the state of an experiment. Specifically, it remembers which group the user was assigned to.

#### Scope Interface ####

| Function           | Description                              |
| ------------------ | :--------------------------------------- |
| `.get(key)`        | Get the value under key `key`            |
| `.set(key, value)` | Set the value under key `key` to `value` |

#### Example ####

```js
var scope = new Scope();

// Get the group the user was assigned to in the 'button-color' experiment
scope.get('button-color');

// Set the group the user was assigned to in the 'button-color' experiment to 'red'
scope.set('button-color', 'red');
```

#### CookieScope ####

```js
var scope = new CookieScope();

// Get the group the user was assigned to from a cookie
scope.get('button-color');

// Set the group the user was assigned to in the cookie
scope.set('button-color', 'red');
```
