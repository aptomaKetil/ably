## Architecture

Ably contains a collection of *experiments*.

Each *experiment* has its own *randomizer* and its own *scope*.

![Ably experiment architecture](ably-experiment-architecture.png)

### Randomizer ###

A randomizer assigns test subjects to groups.

A randomizer matches the following prototype:

```js
/**
 * Assigns to a variant by calling the callback
 * @param  {Function} callback The callback to pass the variant to
 * @param  {AblyTest} test The test being randomized
 */
function randomizer(callback, test);
```

#### Example

```js
/**
 * Assigns to a variant using the Math.random() method
 * @param  {Function} callback The callback to pass the variant to
 * @param  {AblyTest} test The test being randomized
 */
function exampleRandomizer(callback, test) {
    callback(test.variants[Math.floor(Math.random() * test.variants.length)]);
}
```

#### Use an existing randomizer

Ably exposes a randomizer you can use out of the box.

##### The `uniform` randomizer

A type of randomizer that assigns users to groups with equal probability of being assigned to each group. 

Example:

If you have two variants: `A` and `B`, you will get 50% chance of being assigned to group `A` and 50% chance of being assigned to group `B`. If you have three variants: `A`, `B` and `C`, you will get roughly 33.33% chance of being assigned to each group.

The randomizer relies on the uniform distribution of values of the `Math.random()` function.

To use it, supply `'uniform'` as the value of the `'randomizer'` option when adding a test.

Usage example:

```js
// Add a test
ably.addTest({
    name: 'button-color',
    variants: ['red', 'green'],
    randomizer: 'uniform',
    scope: 'cookie'
});
```

#### Supply your own randomizer

##### Examples

Fetch the assignment from a dataset generated by the server.

```js
ably.setRandomizer(function myServerGeneratedRandomizer(callback, test) {
    callback(document.getElementById('server-generated-data').dataset.assignment);
});
```

Fetch the assignment through AJAX.

```js
ably.setRandomizer(function myServerGeneratedRandomizer(callback, test) {
    $.getJSON("/assigment", function(json) {
        callback(json.assigment);
    });
});
```

### Scope ###

A scope represents the scope of an experiment. It marks the boundary of where the experiment begins and where it ends. An experiment can be run within the scope of a cookie or within the scope of a logged-in session. A scope is simply a key-value store which remembers the state of an experiment. Specifically, it remembers which group the user was assigned to.

#### Scope Interface ####

The Scope interface is partially consistent with [the Web Storage interface](http://dev.w3.org/html5/webstorage/#storage-0).

| Function                  | Description                              |
| ------------------------- | :--------------------------------------- |
| `.hasItem(key)`           | True if the scope has a value for `key`  |
| `.getItem(key)`           | Get the value under `key`                |
| `.setItem(key, value)`    | Set the value under `key` to `value`     |

#### Example ####

```js
// See if the user was assigned to a group in the 'button-color' experiment
scope.hasItem('button-color');

// Get the group the user was assigned to in the 'button-color' experiment
scope.getItem('button-color');

// Set the group the user was assigned to in the 'button-color' experiment to 'red'
scope.setItem('button-color', 'red');
```
