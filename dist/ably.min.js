!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):"object"==typeof exports?exports.Ably=e():t.Ably=e()}(this,function(){return function(t){function e(n){if(s[n])return s[n].exports;var r=s[n]={exports:{},id:n,loaded:!1};return t[n].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var s={};return e.m=t,e.c=s,e.p="",e(0)}([function(t,e,s){"use strict";var n=s(2),r=s(1),i=function(t){function e(t){for(var e,s=[],n=0;n<l.pendingSubscribers.length;n++)e=l.pendingSubscribers[n],e.matchesTest(t)?t.addSubscriber(e):s.push(e);l.pendingSubscribers=s}function s(t,e){t(e.variants[Math.floor(Math.random()*e.variants.length)])}function i(t,e){var n,r,i=0,o=0;if("undefined"==typeof e.weights)return s(t,e);for(r in e.weights)e.weights.hasOwnProperty(r)&&(i+=e.weights[r]);n=Math.random()*i;for(r in e.weights)if(e.weights.hasOwnProperty(r)){if(n<o+e.weights[r])return void t(r);o+=e.weights[r]}}function o(t){if(!t.hasOwnProperty("sampler"))return l.samplers["default"];if("function"==typeof t.sampler)return t.sampler;if(l.samplers.hasOwnProperty(t.sampler))return l.samplers[t.sampler];throw new Error("sampler '"+t.sampler+"' not found")}function a(t){var e,s;for(e=0;e<t.length;e++)if(s=t[e],"function"!=typeof s.isAvailable||s.isAvailable())return s;throw new Error("no available scope provided")}function c(t){return a([t,l.scopes.pageview])}function u(t){if(!t.hasOwnProperty("scope"))return c(l.scopes["default"]);if("object"==typeof t.scope)return c(t.scope);if(l.scopes.hasOwnProperty(t.scope))return c(l.scopes[t.scope]);throw new Error("scope '"+t.scope+"' not found")}var p={},h={hasItem:function(t){return p.hasOwnProperty(t)},getItem:function(t){return p[t]},setItem:function(t,e){p[t]=e},isAvailable:function(){return!0}},f={hasItem:function(t){return null!==localStorage.getItem(t)},getItem:function(t){return localStorage.getItem(t)},setItem:function(t,e){localStorage.setItem(t,e)},isAvailable:function(){var t="__test_localStorage_capability_ably_18c09e96bdd2cfe6ca47f3285f1b935d";try{var e=window.localStorage;return e.setItem(t,"1"),e.removeItem(t),!0}catch(s){return!1}}};void 0===t&&(t="default"),this.namespace=t,this.tests=[],this.pendingSubscribers=[],this.samplers={local:i,"default":i},this.scopes={pageview:h,device:f,"default":f};var l=this;this.when=function(t,e,s){var n={test:t};"function"==typeof e?s=e:n.variant=e,n.callback=s;var i,o=new r(n);try{i=this.getTest(o.test)}catch(a){return this.pendingSubscribers.push(o),this}return i.addSubscriber(o),this},this.addTest=function(t){var s=new n({name:t.name,variants:t.variants,sampler:o(t),scope:u(t),weights:t.weights});return this.tests.push(s),e(s),this}};i.prototype.addTests=function(t){for(var e=0;e<t.length;e++)this.addTest(t[e]);return this},i.prototype.getTest=function(t){for(var e=0;e<this.tests.length;e++)if(this.tests[e].name===t)return this.tests[e];throw new Error("test '"+t+"' not found")},i.prototype.getTests=function(){return this.tests},t.exports=i},function(t,e){"use strict";var s=function(t){this.test=t.test,t.hasOwnProperty("variant")&&(this.variant=t.variant),this.callback=t.callback};s.prototype.notify=function(t){var e=this;setTimeout(function(){e.callback(t)},1)},s.prototype.matchesTest=function(t){return this.test===t.name},s.prototype.matchesTestAndVariant=function(t,e){return this.hasOwnProperty("variant")?this.test===t&&this.variant===e:this.test===t},t.exports=s},function(t,e){"use strict";var s=function(t){function e(){for(var t,e=0;e<a.subscribers.length;e++)t=a.subscribers[e],t.matchesTestAndVariant(a.name,a.getAssignment())&&t.notify(a);a.subscribers=[]}function s(){r()||(i(),a.sampler(function(t){o(),n(t),e()},a))}function n(t){a.scope.setItem(a.name,t)}function r(){return a.hasOwnProperty("pendingAssignment")}function i(){a.pendingAssignment=!0}function o(){delete a.pendingAssignment}this.name=t.name,this.sampler=t.sampler,this.scope=t.scope,this.variants=t.variants,this.weights=t.weights,this.subscribers=[];var a=this;this.addSubscriber=function(t){this.subscribers.push(t),this.hasAssignment()?e():s()}};s.prototype.hasAssignment=function(){return this.scope.hasItem(this.name)},s.prototype.getAssignment=function(){return this.scope.getItem(this.name)},t.exports=s}])});